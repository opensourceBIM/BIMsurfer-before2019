<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Example</title>
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:300,600' rel='stylesheet' type='text/css' />
    
    <link rel="stylesheet" href="css/demo.css"/>
    <link rel="stylesheet" href="../css/tree.css"/>
    <link rel="stylesheet" href="../css/metadata.css"/>
    
    <script>
    // http://stackoverflow.com/questions/979975/how-to-get-the-value-from-the-get-parameters
    var QueryString = function () {
    	  // This function is anonymous, is executed immediately and 
    	  // the return value is assigned to QueryString!
    	  var query_string = {};
    	  var query = window.location.search.substring(1);
    	  var vars = query.split("&");
    	  for (var i=0;i<vars.length;i++) {
    	    var pair = vars[i].split("=");
    	        // If first entry with this name
    	    if (typeof query_string[pair[0]] === "undefined") {
    	      query_string[pair[0]] = decodeURIComponent(pair[1]);
    	        // If second entry with this name
    	    } else if (typeof query_string[pair[0]] === "string") {
    	      var arr = [ query_string[pair[0]],decodeURIComponent(pair[1]) ];
    	      query_string[pair[0]] = arr;
    	        // If third or later entry with this name
    	    } else {
    	      query_string[pair[0]].push(decodeURIComponent(pair[1]));
    	    }
    	  } 
    	  return query_string;
    	}();
        var ADDRESS = "https://thisisanexperimentalserver.com";
        var USERNAME = "bimsurfer@logic-labs.nl";
        var PASSWORD = "bimsurfer";
        var VERSION = "2.0";

        // This is a bit awkard. This seems to be necessary in order for the
        // BIMserver modules to find themselves, but it destroys any option
        // for further modularization in the client and ability to use data-main.
        var require = {
            baseUrl: "../",
            urlArgs: "bust=" + VERSION
        };

        // Where does this come frome? The API crashes on the absence of this
        // member function?
        String.prototype.firstUpper = function () {
            return this.charAt(0).toUpperCase() + this.slice(1);
        }
    </script>

	<script type="text/javascript" src="https://thisisanexperimentalserver.com/apps/bimserverjavascriptapi/js/bimserverapiwebsocket.js"></script>
	<script type="text/javascript" src="https://thisisanexperimentalserver.com/apps/bimserverjavascriptapi/js/bimserverclient.js"></script>
	<script type="text/javascript" src="https://thisisanexperimentalserver.com/apps/bimserverjavascriptapi/js/bimserverapipromise.js"></script>
	<script type="text/javascript" src="https://thisisanexperimentalserver.com/apps/bimserverjavascriptapi/js/ifc2x3tc1.js"></script>
	<script type="text/javascript" src="https://thisisanexperimentalserver.com/apps/bimserverjavascriptapi/js/ifc4.js"></script>
	<script type="text/javascript" src="https://thisisanexperimentalserver.com/apps/bimserverjavascriptapi/js/model.js"></script>
	<script type="text/javascript" src="https://thisisanexperimentalserver.com/apps/bimserverjavascriptapi/js/translations_en.js"></script>
    <script type="text/javascript" src="../bimsurfer/lib/require.js"></script>
    <script type="text/javascript" src="../bimsurfer/lib/xeoengine.js"></script>
    <script type="text/javascript">

        // Loads a model from BIMServer, builds an explorer tree UI.
        // Clicking on a tree node fits the view to its scene object.

        require(["bimsurfer/src/BimSurfer","bimsurfer/src/StaticTreeRenderer","bimsurfer/src/MetaDataRenderer","bimsurfer/lib/domReady!"],
        function (BimSurfer, StaticTreeRenderer, MetaDataRenderer) {

            var bimSurfer = new BimSurfer({
                domNode: "viewerContainer"
            });

            // Load a model from BIMServer
            bimSurfer.load({
                bimserver: ADDRESS,
                username: USERNAME,
                password: PASSWORD,
                poid: QueryString.poid,
                roid: QueryString.roid,
                schema: "ifc2x3tc1" // < TODO: Deduce automatically
            }).then(function (model) {
                model.getTree().then(function (tree) {
                
                    // Build a tree view of the elements in the model. The fact that it
                    // is 'static' refers to the fact that all branches are loaded and
                    // rendered immediately.
                    var domtree = new StaticTreeRenderer({
                        domNode: 'treeContainer'
                    });
                    domtree.addModel({name: "", id:QueryString.roid, tree:tree});
                    domtree.build();
                    
                    // Add a widget that displays metadata (IfcPropertySet and instance
                    // attributes) of the selected element.
                    var metadata = new MetaDataRenderer({
                        domNode: 'dataContainer'
                    });
                    metadata.addModel({name: "", id:QueryString.roid, model:model});
                    
                    bimSurfer.on("selection-changed", function(selected) {
                        domtree.setSelected(selected, domtree.SELECT_EXCLUSIVE);
                        metadata.setSelected(selected);
                    });
                    
                    domtree.on("click", function (oid) {
                        // Clicking an explorer node fits the view to its object
                        bimSurfer.setColor({
                            ids: [oid],
                            color: [1,0,0,1]
                        });
                        bimSurfer.viewFit({
                            ids: [oid],
                            animate: true
                        });
                    });
                });
            });

            // Lets us play with the Surfer in the console
            window.bimSurfer = bimSurfer;
        });
    </script>

</head>
<body>
<div id="maincontainer">

    <div id="topsection"><h1>BIMSurfer example</h1></div>

    <div id="contentwrapper">
        <div id="colmid">
            <div id="colright">
                <div id="col1wrap">
                    <div id="col1pad">
                        <div id="viewerContainer">
                        </div>
                    </div>
                </div>
                <div id="treeContainer" class="bimsurfer-static-tree">
                </div>
                <div id="dataContainer" class="bimsurfer-metadata">
                </div>
            </div>
        </div>
    </div>
    
</div>

</body>
</html>